version: '3.8'

services:
  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ovpn-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      # SQLite 数据库持久化
      - ./backend/data:/app/data
      # 挂载宿主机 OpenVPN 目录（只读）
      - /etc/openvpn:/etc/openvpn:ro
      - /var/log/openvpn:/var/log/openvpn:ro
      # 需要写入的目录（CCD、客户端配置导出）
      - /etc/openvpn/ccd:/etc/openvpn/ccd
      - /etc/openvpn/client-configs:/etc/openvpn/client-configs
    environment:
      # 覆盖默认配置（可根据实际调整）
      - SECRET_KEY=your-super-secret-key-change-in-production
      - DEFAULT_ADMIN_USERNAME=admin
      - DEFAULT_ADMIN_PASSWORD=admin456
      - DEPLOY_ENV=PROD
      - LOG_LEVEL=INFO
      - CORS_ORIGINS=["http://localhost","http://127.0.0.1"]
      - OPENVPN_SERVICE_NAME=openvpn@server
      - OPENVPN_BASE_PATH=/etc/openvpn
      - EASYRSA_PATH=/etc/openvpn/easy-rsa
      - CCD_PATH=/etc/openvpn/ccd
      - OPENVPN_STATUS_PATH=/var/log/openvpn/openvpn-status.log
      - OPENVPN_MANAGEMENT_HOST=172.17.0.1
      - OPENVPN_MANAGEMENT_PORT=7505
      - OPENVPN_CRL_PATH=/etc/openvpn/server/crl.pem
      - OPENVPN_CLIENT_EXPORT_PATH=/etc/openvpn/client-configs
      - TA_KEY_PATH=/etc/openvpn/server/ta.key
      - SERVER_CONF_PATH=/etc/openvpn/server.conf
      - PUBLIC_IP=your-public-ip
      - PUBLIC_PORT=1194
    # 使用宿主机网络模式以访问 systemd 和 management 接口
    network_mode: host
    privileged: true
    depends_on: []

  # 前端服务（Nginx）
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ovpn-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    environment:
      # 前端通过环境变量或构建时指定后端 API 地址
      - VITE_API_BASE=http://localhost:8000/api
    depends_on:
      - backend

volumes:
  backend-data:
    driver: local

networks:
  default:
    driver: bridge
